<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏î‡∏¥‡∏ô/‡∏ß‡∏¥‡πà‡∏á</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Kanit&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    body { font-family: 'Kanit', sans-serif; padding: 20px; }
    h2, h4 { text-align: center; }
    .hidden { display: none; }
    #filePreviewContainer { margin-top: 10px; text-align: center; }
    #imagePreview, #videoPreview { max-width: 100%; max-height: 200px; border: 1px solid #ddd; margin-top: 5px;}
  </style>
</head>
<body>
  <div class="container mt-5">
    <h2 class="mb-4">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏î‡∏¥‡∏ô/‡∏ß‡∏¥‡πà‡∏á</h2>
    <form id="challenge-form">
      <div class="form-group">
        <label for="team">üî¥ ‡∏ó‡∏µ‡∏°:</label>
        <select id="team" class="form-control" disabled><option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î...</option></select>
      </div>
      <div class="form-group">
        <label for="jocName">üîª ‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏ó‡∏ô. JOC.10:</label>
        <select id="jocName" class="form-control" disabled><option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î...</option></select>
      </div>
      <div class="form-group">
        <label for="officerName">üîª ‡∏ä‡∏∑‡πà‡∏≠ ‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ ‡∏™‡∏®‡∏ó.‡∏™‡∏õ‡∏ó.:</label>
        <input id="officerName" type="text" class="form-control" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
      </div>
      <div class="form-group">
        <label for="distance">üîª ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏î‡∏¥‡∏ô/‡∏ß‡∏¥‡πà‡∏á (‡∏Å‡∏°.):</label>
        <input id="distance" type="number" class="form-control" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏∞‡∏¢‡∏∞ (‡πÄ‡∏ä‡πà‡∏ô 5.2)" step="0.1" required>
      </div>
      <div class="form-group">
        <label for="fileUpload">üñºÔ∏è ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û/‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 50MB):</label>
        <input type="file" id="fileUpload" class="form-control-file" accept="image/*,video/*">
        <div id="filePreviewContainer" class="hidden">
          <p>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</p>
          <img id="imagePreview" src="#" alt="Image Preview" class="hidden"/>
          <video id="videoPreview" controls autoplay muted playsinline class="hidden"></video>
        </div>
      </div>
      <button type="button" id="preview-button" class="btn btn-primary btn-block" onclick="previewData()">‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
    </form>

    <div id="confirmation-container" class="hidden mt-4">
      <h4>‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å</h4>
      <ul id="data-summary" class="list-group mb-3"></ul>
      <div class="d-flex justify-content-around">
        <button class="btn btn-success" onclick="submitData()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á</button>
        <button class="btn btn-secondary" onclick="editData()">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
      </div>
    </div>

    <div id="success-section" class="hidden mt-4 text-center">
      <h4>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</h4>
      <p id="successMessage"></p>
    </div>

    <div id="error-message" class="alert alert-danger text-center hidden"></div>
  </div>

  <script>
   // =================================================================
        // ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Cache ‡∏Ç‡∏≠‡∏á LIFF
        // =================================================================
        const originalFetch = window.fetch;
        window.fetch = async function(url, options) {
            if (url.toString().startsWith('https://liffsdk.line-scdn.net/') && url.toString().endsWith('.json')) {
                url = url + '?ts=' + Math.random();
            }
            return originalFetch(url, options);
        };
        // =================================================================
  
    // =================================================================
    // ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡πà‡∏≤ 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    // =================================================================
    const liffId = "2007483213-M8nB0DEV";
    const scriptURL = "https://script.google.com/macros/s/AKfycbzfiEl9j14L25hhGKciyTpWQewnmebs2aSWvWOMkLOEuZdbJiGLQOCPUN5IB1h-JFA/exec";
    // =================================================================

    let formData = {};
    let selectedFile = null;
    let selectedFileBase64 = null;

    async function initializeLiff() {
      try {
        await liff.init({ liffId });
        const previewButton = document.getElementById('preview-button');
        previewButton.disabled = true;
        previewButton.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ü‡∏≠‡∏£‡πå‡∏°...';
        await Promise.all([
          populateDropdown('‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'A', 'team'),
          populateDropdown('‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'B', 'jocName')
        ]);
        previewButton.disabled = false;
        previewButton.innerText = '‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á';
      } catch (err) {
        console.error("LIFF/Dropdown Initialization Error:", err);
        document.getElementById('error-message').innerText = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô";
        document.getElementById('error-message').classList.remove('hidden');
      }
    }

    async function populateDropdown(sheet, column, selectId) {
      const sel = document.getElementById(selectId);
      try {
        const res = await fetch(`${scriptURL}?action=getDropdown&sheet=${encodeURIComponent(sheet)}&column=${encodeURIComponent(column)}`);
        if (!res.ok) throw new Error(`Network error: ${res.status}`);
        const list = await res.json();
        if (list.status === 'error') throw new Error(list.message);
        sel.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>`;
        list.forEach(item => {
          const opt = new Option(item, item);
          sel.add(opt);
        });
      } catch (error) {
        console.error(`Failed to populate ${selectId}:`, error);
        sel.innerHTML = `<option value="">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>`;
      } finally {
        sel.disabled = false;
      }
    }

    // ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ
    document.getElementById('fileUpload').addEventListener('change', function(event) {
        const file = event.target.files[0];
        const previewContainer = document.getElementById('filePreviewContainer');
        const imagePreview = document.getElementById('imagePreview');
        const videoPreview = document.getElementById('videoPreview');
        const resetAll = () => {
            selectedFile = selectedFileBase64 = null;
            imagePreview.classList.add('hidden'); 
            videoPreview.classList.add('hidden');
            previewContainer.classList.add('hidden'); 
            event.target.value = '';
        };

        if (!file) { resetAll(); return; }
        if (file.size > 50 * 1024 * 1024) { alert('‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 50MB'); resetAll(); return; }
        
        selectedFile = file;
        const reader = new FileReader();

        reader.onload = function(e) {
            selectedFileBase64 = e.target.result;
            const isImage = file.type.startsWith('image/');
            
            imagePreview.src = isImage ? selectedFileBase64 : '#';
            videoPreview.src = isImage ? '' : selectedFileBase64;
            
            imagePreview.classList.toggle('hidden', !isImage);
            videoPreview.classList.toggle('hidden', isImage);
            
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            if (!isImage) {
                videoPreview.load();
                videoPreview.play().catch(error => {
                    console.log("Browser prevented autoplay. The 'muted' attribute should allow it.", error);
                });
            }
            
            previewContainer.classList.remove('hidden');
        }
        reader.readAsDataURL(file);
    });

    function previewData() {
      const team = document.getElementById('team').value;
      const jocName = document.getElementById('jocName').value;
      const officerName = document.getElementById('officerName').value;
      const distance = document.getElementById('distance').value;
      if (!team || !distance || parseFloat(distance) <= 0) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô: ‡∏ó‡∏µ‡∏° ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0'); return; }
      if (!officerName && !jocName) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å "‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏ó‡∏ô. JOC.10" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏ä‡∏∑‡πà‡∏≠ ‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ ‡∏™‡∏®‡∏ó.‡∏™‡∏õ‡∏ó." ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ä‡πà‡∏≠‡∏á'); return; }
      formData = {
        Timestamp: new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' }),
        team, jocName: jocName || '(‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏)', officerName: officerName || '(‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏)', distance,
        fileName: selectedFile ? selectedFile.name : '(‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå)'
      };
      const summary = document.getElementById('data-summary');
      summary.innerHTML = `<li class="list-group-item"><strong>‡∏ó‡∏µ‡∏°:</strong> ${formData.team}</li><li class="list-group-item"><strong>‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏ó‡∏ô. JOC.10:</strong> ${formData.jocName}</li><li class="list-group-item"><strong>‡∏ä‡∏∑‡πà‡∏≠ ‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ ‡∏™‡∏®‡∏ó.‡∏™‡∏õ‡∏ó.:</strong> ${formData.officerName}</li><li class="list-group-item"><strong>‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏Å‡∏°.):</strong> ${formData.distance}</li><li class="list-group-item"><strong>‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</strong> ${formData.fileName}</li>`;
      document.getElementById('challenge-form').classList.add('hidden');
      document.getElementById('confirmation-container').classList.remove('hidden');
    }

    function editData() {
      document.getElementById('confirmation-container').classList.add('hidden');
      document.getElementById('challenge-form').classList.remove('hidden');
    }

    function generateVideoThumbnail(file) {
      return new Promise((resolve, reject) => {
        const video = document.createElement('video');
        const canvas = document.createElement('canvas');
        const reader = new FileReader();
        reader.onload = (e) => {
          video.src = e.target.result;
          video.muted = true;
          video.onloadeddata = () => video.currentTime = 1; 
          video.onseeked = () => {
            window.requestAnimationFrame(() => {
              canvas.width = video.videoWidth;
              canvas.height = video.videoHeight;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
              resolve(canvas.toDataURL('image/jpeg')); 
            });
          };
        };
        reader.onerror = (error) => reject(error);
        reader.readAsDataURL(file);
      });
    }

    function createLineMessageForFile(fileType, fileUrl, previewUrl) {
        if (fileType.startsWith('image/')) {
            return { type: 'image', originalContentUrl: fileUrl, previewImageUrl: fileUrl };
        }
        if (fileType.startsWith('video/')) {
            if (previewUrl) {
                return { type: 'video', originalContentUrl: fileUrl, previewImageUrl: previewUrl };
            }
        }
        return null;
    }

    async function submitData() {
        document.getElementById('confirmation-container').classList.add('hidden');
        document.getElementById('success-section').classList.remove('hidden');
        
        let detailedLineMessage = `üèÉüèª‚Äç‚ôÇÔ∏èüèÉüèª‚Äç‚ôÇÔ∏è ‡∏Å‡∏≤‡∏£‡∏™‡∏∞‡∏™‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏î‡∏¥‡∏ô/‡∏ß‡∏¥‡πà‡∏á:\n\n` +
                                  `üî¥ ‡∏ó‡∏µ‡∏°:  ${formData.team}\n` +
                                  `üîª‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏ó‡∏ô. JOC.10:  ${formData.jocName}\n` +
                                  `üîª‡∏ä‡∏∑‡πà‡∏≠ ‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ ‡∏™‡∏®‡∏ó.‡∏™‡∏õ‡∏ó.:  ${formData.officerName}\n` +
                                  `üîª‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏î‡∏¥‡∏ô/‡∏ß‡∏¥‡πà‡∏á ‡∏Å‡∏°.:  ${formData.distance}\n\n`;
        try {
            document.getElementById('successMessage').innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheet...';
            const textPromise = fetch(scriptURL, {
                method: 'POST',
                body: new URLSearchParams({ action: 'submitText', textData: JSON.stringify(formData) })
            }).then(res => res.json());

            let fileUrl = null;
            let previewImageUrl = null;

            if (selectedFile) {
                if (selectedFile.type.startsWith('video/')) {
                    document.getElementById('successMessage').innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û‡∏õ‡∏Å‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠...';
                    const thumbnailBase64 = await generateVideoThumbnail(selectedFile);
                    document.getElementById('successMessage').innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏õ‡∏Å...';
                    const thumbResult = await fetch(scriptURL, {
                        method: 'POST',
                        body: new URLSearchParams({
                            action: 'uploadThumbnail',
                            fileData: thumbnailBase64,
                            fileName: `thumb_${selectedFile.name.split('.')[0]}.jpg`,
                            mimeType: 'image/jpeg'
                        })
                    }).then(res => res.json());
                    if (thumbResult.status === 'success') previewImageUrl = thumbResult.fileUrl;
                    else throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏õ‡∏Å‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÑ‡∏î‡πâ');
                }
                
                document.getElementById('successMessage').innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏±‡∏Å...';
                const fileResult = await fetch(scriptURL, {
                    method: 'POST',
                    body: new URLSearchParams({
                        action: 'uploadFile',
                        fileData: selectedFileBase64,
                        fileName: selectedFile.name,
                        mimeType: selectedFile.type
                    })
                }).then(res => res.json());
                if (fileResult.status === 'success') fileUrl = fileResult.fileUrl;
                else detailedLineMessage += `\n\n(‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${fileResult.message})`;
            }
            
            document.getElementById('successMessage').innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•...';
            const [textResult, summarySheetData] = await Promise.all([textPromise, fetchSummarySheetData()]);
            if (textResult.status !== 'success') throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÑ‡∏î‡πâ');
            
            const lineMessagesToSend = [];
            if (fileUrl) {
                const fileMessage = createLineMessageForFile(selectedFile.type, fileUrl, previewImageUrl);
                if (fileMessage) lineMessagesToSend.push(fileMessage);
                else detailedLineMessage += `\nüìé ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ö (‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ):\n${fileUrl}`;
            }

            detailedLineMessage += "üèÜ ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• Run Challenge:\n";
            if (summarySheetData) {
                detailedLineMessage += `üéØ ‡∏£‡∏∞‡∏¢‡∏∞ Challenge: ${summarySheetData.challengeGoal || 'N/A'} ‡∏Å‡∏°.\n`;
                detailedLineMessage += `üìà ‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏∞‡∏™‡∏°: ${summarySheetData.totalAccumulated?.toFixed(2) || 'N/A'} ‡∏Å‡∏°.\n\n`;
                summarySheetData.teams?.forEach(team => {
                    if (team.name) detailedLineMessage += `üîª ‡∏ó‡∏µ‡∏° ${team.name}\n ‚Ä¢ ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: ${team.distance?.toFixed(2) || 'N/A'} ‡∏Å‡∏°. | ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö: ${team.rank || 'N/A'}\n\n`;
                });
            } else {
                detailedLineMessage += "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡πÑ‡∏î‡πâ\n\n";
            }
            detailedLineMessage += `‚ÄºÔ∏è‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡πà‡∏á‡∏£‡∏∞‡∏¢‡∏∞: https://liff.line.me/${liffId}`;
            
            lineMessagesToSend.unshift({ type: 'text', text: detailedLineMessage });
            if (liff.isInClient()) {
                document.getElementById('successMessage').innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏õ‡∏ó‡∏µ‡πà LINE...';
                await liff.sendMessages(lineMessagesToSend);
                document.getElementById('successMessage').innerText = '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!';
                setTimeout(() => liff.closeWindow(), 1500);
            } else {
                alert("‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡πÅ‡∏≠‡∏õ LINE ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ");
                document.getElementById('successMessage').innerText = '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! (‡∏ô‡∏≠‡∏Å‡πÅ‡∏≠‡∏õ LINE)';
            }
        } catch (e) {
            console.error('Error submitting data:', e);
            document.getElementById('success-section').classList.add('hidden');
            document.getElementById('error-message').innerText = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${e.message}`;
            document.getElementById('error-message').classList.remove('hidden');
        }
    }
    
    async function fetchSummarySheetData() {
        try {
            const res = await fetch(`${scriptURL}?action=getSummaryResults`);
            const result = await res.json();
            return (result.status === 'success') ? result.data : null;
        } catch (error) {
            console.error("Error fetching summary sheet data:", error);
            return null;
        }
    }

    window.onload = initializeLiff;
  </script>
</body>
</html>
